<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Copilot Analytics Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/cyborg/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --neon-green: #39FF14;
            --neon-green-dim: #2fb912;
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --border-color: #333;
            --text-muted: #888;
        }
        
        * { box-sizing: border-box; }
        
        body { 
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        /* Main Container */
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Header */
        .dashboard-header {
            text-align: center;
            margin-bottom: 3rem;
            position: relative;
        }
        
        .dashboard-title {
            font-size: 2.5rem;
            font-weight: 300;
            letter-spacing: 2px;
            color: #fff;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }
        
        .dashboard-subtitle {
            color: var(--text-muted);
            font-size: 1rem;
            letter-spacing: 1px;
        }
        
        .glow-text {
            text-shadow: 0 0 10px var(--neon-green), 0 0 20px var(--neon-green);
        }
        
        /* Modern Tab Navigation */
        .modern-tabs {
            gap: 1rem;
            margin-bottom: 2rem;
            background: var(--bg-secondary);
            padding: 0.5rem;
            border-radius: 12px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
            border: none;
        }
        
        .modern-tabs .nav-item {
            flex: 1;
        }
        
        .modern-tab {
            width: 100%;
            padding: 1rem 2rem;
            background: transparent !important;
            border: none !important;
            color: var(--text-muted);
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .modern-tab:hover {
            color: #fff !important;
            background: rgba(57, 255, 20, 0.1) !important;
        }
        
        .modern-tab.active {
            background: var(--neon-green) !important;
            color: #000 !important;
            font-weight: 600;
            box-shadow: 0 0 20px rgba(57, 255, 20, 0.5);
        }
        
        .modern-tab i {
            margin-right: 0.5rem;
        }
        
        /* Cards */
        .glass-card {
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(57, 255, 20, 0.2);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
            border-color: rgba(57, 255, 20, 0.4);
        }
        
        .card-header-modern {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(57, 255, 20, 0.2);
        }
        
        .card-header-modern i {
            color: var(--neon-green);
            font-size: 1.25rem;
        }
        
        .card-header-modern h5 {
            margin: 0;
            font-weight: 500;
            color: #fff;
            font-size: 1.1rem;
        }
        
        /* Metric Cards */
        .metric-card-modern {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border: 1px solid rgba(57, 255, 20, 0.2);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .metric-card-modern::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(57, 255, 20, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .metric-card-modern:hover::before {
            opacity: 1;
        }
        
        .metric-card-modern:hover {
            transform: translateY(-4px);
            border-color: var(--neon-green);
            box-shadow: 0 8px 24px rgba(57, 255, 20, 0.2);
        }
        
        .metric-value {
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--neon-green);
            line-height: 1;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 20px rgba(57, 255, 20, 0.5);
        }
        
        .metric-label {
            color: var(--text-muted);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Buttons */
        .btn-neon {
            background: linear-gradient(135deg, var(--neon-green) 0%, var(--neon-green-dim) 100%);
            border: none;
            color: #000;
            font-weight: 600;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(57, 255, 20, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .btn-neon:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(57, 255, 20, 0.5);
            background: linear-gradient(135deg, #fff 0%, var(--neon-green) 100%);
        }
        
        .btn-neon:active {
            transform: translateY(0);
        }
        
        .btn-neon i {
            margin-right: 0.5rem;
        }
        
        /* Neon Outline Button */
        .btn-neon-outline {
            background: transparent;
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
            font-weight: 500;
            padding: 0.5rem 1.5rem;
            border-radius: 6px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.875rem;
        }
        
        .btn-neon-outline:hover {
            background: var(--neon-green);
            color: #000;
            box-shadow: 0 0 15px rgba(57, 255, 20, 0.5);
            transform: translateY(-1px);
        }
        
        .btn-neon-outline:active {
            transform: translateY(0);
        }
        
        /* Form Controls */
        .form-control-modern {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: #fff;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }
        
        .form-control-modern:focus {
            background: var(--bg-secondary);
            border-color: var(--neon-green);
            color: #fff;
            box-shadow: 0 0 0 0.2rem rgba(57, 255, 20, 0.25);
        }
        
        .form-select-modern {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: #fff;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .form-select-modern:focus {
            border-color: var(--neon-green);
            box-shadow: 0 0 0 0.2rem rgba(57, 255, 20, 0.25);
        }
        
        /* File Upload Area */
        .upload-area {
            border: 2px dashed rgba(57, 255, 20, 0.4);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            background: rgba(57, 255, 20, 0.05);
        }
        
        .upload-area:hover {
            border-color: var(--neon-green);
            background: rgba(57, 255, 20, 0.1);
            border-style: solid;
        }
        
        .upload-area i {
            font-size: 3rem;
            color: var(--neon-green);
            margin-bottom: 1rem;
            opacity: 0.8;
        }
        
        .upload-area p {
            color: #aaa;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        /* Status Messages */
        .status-message {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .status-success {
            background: rgba(57, 255, 20, 0.1);
            border: 1px solid rgba(57, 255, 20, 0.3);
            color: var(--neon-green);
        }
        
        .status-error {
            background: rgba(255, 65, 54, 0.1);
            border: 1px solid rgba(255, 65, 54, 0.3);
            color: #ff4136;
        }
        
        /* Charts */
        .chart-container-modern {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            min-height: 300px;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--neon-green);
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(57, 255, 20, 0.5);
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #fff;
        }
        
        /* Loading Animation */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--neon-green);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 1rem;
            }
            
            .dashboard-title {
                font-size: 1.75rem;
            }
            
            .modern-tabs {
                flex-direction: column;
            }
            
            .metric-value {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <h1 class="dashboard-title">
                <i class="fas fa-chart-line" style="color: var(--neon-green);"></i>
                Copilot Analytics <span class="glow-text">Dashboard</span>
            </h1>
            <p class="dashboard-subtitle">AI-Powered Usage Intelligence Platform</p>
        </div>
        
        <!-- Modern Tab Navigation -->
        <ul class="nav nav-pills modern-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link modern-tab active" id="analysis-tab" data-bs-toggle="tab" data-bs-target="#analysis-pane" type="button" role="tab" aria-controls="analysis-pane" aria-selected="true">
                    <i class="fas fa-analytics"></i>Analysis
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link modern-tab" id="deepdive-tab" data-bs-toggle="tab" data-bs-target="#deepdive-pane" type="button" role="tab" aria-controls="deepdive-pane" aria-selected="false">
                    <i class="fas fa-microscope"></i>Deep Dive
                </button>
            </li>
        </ul>
        <div class="tab-content" id="myTabContent">
            <!-- ANALYSIS TAB -->
            <div class="tab-pane fade show active" id="analysis-pane" role="tabpanel">
                <div class="row g-4">
                    <!-- Left Column -->
                    <div class="col-lg-4">
                        <!-- File Upload Card -->
                        <div class="glass-card mb-4">
                            <div class="card-header-modern">
                                <i class="fas fa-file-upload"></i>
                                <h5>Data Sources</h5>
                            </div>
                            
                            <div class="mb-4">
                                <label class="form-label text-muted small">Target Users (Optional)</label>
                                <div class="upload-area">
                                    <i class="fas fa-users"></i>
                                    <p class="mb-2">Drop CSV file here or click to browse</p>
                                    <input class="form-control form-control-modern" type="file" id="targetUsersFile" accept=".csv,.txt" style="display: none;">
                                    <button class="btn btn-sm btn-neon-outline" onclick="document.getElementById('targetUsersFile').click()">
                                        <i class="fas fa-folder-open"></i> Select File
                                    </button>
                                </div>
                                <div id="target-file-status" class="mt-2"></div>
                            </div>
                            
                            <div>
                                <label class="form-label text-muted small">Usage Reports (Required)</label>
                                <div class="upload-area">
                                    <i class="fas fa-file-csv"></i>
                                    <p class="mb-2">Drop CSV/Excel files here or click to browse</p>
                                    <input class="form-control form-control-modern" type="file" id="usageReports" accept=".csv,.xlsx,.xls" multiple style="display: none;">
                                    <button class="btn btn-sm btn-neon-outline" onclick="document.getElementById('usageReports').click()">
                                        <i class="fas fa-folder-open"></i> Select Files
                                    </button>
                                </div>
                                <div id="usage-files-status" class="mt-2"></div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="d-grid gap-3">
                            <button id="run-analysis-btn" class="btn btn-neon btn-lg">
                                <i class="fas fa-play"></i> Run Analysis
                            </button>
                            <div id="status-label" class="text-center text-muted"></div>
<div id="connection-status" class="text-center text-muted mt-2"></div>
                            <div id="reports-container" style="display: none;">
                                <button id="download-btn" class="btn btn-outline-light btn-lg">
                                    <i class="fas fa-download"></i> Download Reports
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column -->
                    <div class="col-lg-8">
                        <!-- Filters Card -->
                        <div class="glass-card mb-4">
                            <div class="card-header-modern">
                                <i class="fas fa-filter"></i>
                                <h5>Smart Filters</h5>
                            </div>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label text-muted small">Company</label>
                                    <select multiple class="form-select form-select-modern" id="company-filter" size="4"></select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label text-muted small">Department</label>
                                    <select multiple class="form-select form-select-modern" id="department-filter" size="4"></select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label text-muted small">Location</label>
                                    <select multiple class="form-select form-select-modern" id="location-filter" size="4"></select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label text-muted small">Manager</label>
                                    <select multiple class="form-select form-select-modern" id="manager-filter" size="4"></select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Analytics Dashboard -->
                        <div class="glass-card">
                            <div class="card-header-modern">
                                <i class="fas fa-chart-pie"></i>
                                <h5>Analytics Overview</h5>
                            </div>
                            <div class="row g-4">
                                <div class="col-md-4">
                                    <div class="metric-card-modern">
                                        <div class="metric-value" id="total-users">0</div>
                                        <div class="metric-label">Total Users</div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="chart-container-modern" id="distribution-chart"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- DEEP DIVE TAB -->
            <div class="tab-pane fade" id="deepdive-pane" role="tabpanel">
                <div class="glass-card mb-4">
                    <div class="card-header-modern">
                        <i class="fas fa-search"></i>
                        <h5>User Deep Dive Analysis</h5>
                    </div>
                    <p class="text-muted mb-4">Explore detailed insights for individual users. Make sure to run the analysis first.</p>
                    
                    <div class="input-group mb-4">
                        <span class="input-group-text bg-dark border-secondary">
                            <i class="fas fa-envelope"></i>
                        </span>
                        <input type="email" id="user-email-entry" class="form-control form-control-modern" placeholder="user@example.com">
                        <button class="btn btn-neon" type="button" id="search-btn">
                            <i class="fas fa-search"></i> Analyze User
                        </button>
                    </div>
                </div>
                
                <div class="row g-4">
                    <div class="col-lg-5">
                        <div class="glass-card h-100">
                            <div class="card-header-modern">
                                <i class="fas fa-info-circle"></i>
                                <h5>User Metrics</h5>
                            </div>
                            <pre id="deep-dive-results" class="p-3 rounded" style="min-height: 400px; font-size: 0.9rem; background-color: var(--bg-secondary); color: #fff;"></pre>
                        </div>
                    </div>
                    <div class="col-lg-7">
                        <div class="glass-card h-100">
                            <div class="card-header-modern">
                                <i class="fas fa-chart-line"></i>
                                <h5>Usage Trends</h5>
                            </div>
                            <div id="deep-dive-chart-container" class="chart-container-modern" style="min-height: 400px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="/static/js/main.js"></script>
    <script src="/static/js/socket.io.min.js"></script>
    <script src="/static/js/apexcharts.min.js"></script>
    <script>
        // CDN fallback loader with timeout and better error handling
        function loadFallback(src, fallbackSrc, callback) {
            const script = document.createElement('script');
            script.src = src;
            
            // Add timeout for CDN loading
            const timeout = setTimeout(() => {
                console.warn(`CDN loading timeout for ${src}, trying fallback`);
                script.onerror(); // Trigger fallback
            }, 5000);
            
            script.onload = () => {
                clearTimeout(timeout);
                callback();
            };
            
            script.onerror = () => {
                clearTimeout(timeout);
                console.warn(`Failed to load ${src}, trying fallback`);
                
                const fallbackScript = document.createElement('script');
                fallbackScript.src = fallbackSrc;
                
                const fallbackTimeout = setTimeout(() => {
                    console.warn(`Fallback loading timeout for ${fallbackSrc}, proceeding anyway`);
                    callback(); // Proceed even if fallback fails
                }, 3000);
                
                fallbackScript.onload = () => {
                    clearTimeout(fallbackTimeout);
                    callback();
                };
                
                fallbackScript.onerror = () => {
                    clearTimeout(fallbackTimeout);
                    console.error(`Failed to load both ${src} and ${fallbackSrc}, proceeding anyway`);
                    callback(); // Proceed even if both fail
                };
                
                document.head.appendChild(fallbackScript);
            };
            
            document.head.appendChild(script);
        }

        // Load critical resources with fallbacks
        loadFallback(
            'https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js',
            '/static/js/bootstrap.bundle.min.js',
            () => {
                loadFallback(
                    'https://cdn.socket.io/4.7.5/socket.io.min.js',
                    '/static/js/socket.io.min.js',
                    () => {
                        loadFallback(
                            'https://cdn.jsdelivr.net/npm/apexcharts',
                            '/static/js/apexcharts.min.js',
                            initializeApp
                        );
                    }
                );
            }
        );

        function initializeApp() {
            // Your existing main.js content will go here, wrapped in this function
            // This ensures all CDNs are loaded before the app initializes
            // For now, we'll just call the main.js content directly
            // The actual content of main.js will be moved into this function in the next step
            console.log("All critical resources loaded. Initializing app.");
            // Original main.js content will be placed here
            class ChartManager {
                constructor() {
                    this.charts = new Map();
                }
                
                createChart(id, options) {
                    this.destroyChart(id); // Clean up existing chart
                    const chart = new ApexCharts(document.querySelector(id), options);
                    chart.render();
                    this.charts.set(id, chart);
                    return chart;
                }
                
                destroyChart(id) {
                    const chart = this.charts.get(id);
                    if (chart) {
                        chart.destroy();
                        this.charts.delete(id);
                    }
                }
                
                destroyAll() {
                    for (const [id, chart] of this.charts) {
                        chart.destroy();
                    }
                    this.charts.clear();
                }
            }
            
            window.addEventListener('beforeunload', () => {
                if (window.chartManager) {
                    window.chartManager.destroyAll();
                }
            });
            
            class ErrorBoundary {
                static initialize() {
                    window.addEventListener('error', this.handleError);
                    window.addEventListener('unhandledrejection', this.handlePromiseRejection);
                }
                
                static handleError(event) {
                    console.error('Global error:', event.error);
                    this.showRecoveryOptions('An unexpected error occurred.');
                }
                
                static handlePromiseRejection(event) {
                    console.error('Unhandled promise rejection:', event.reason);
                    this.showRecoveryOptions('A network or processing error occurred.');
                }
                
                static showRecoveryOptions(message) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'position-fixed top-0 start-50 translate-middle-x mt-3 alert alert-danger alert-dismissible fade show';
                    errorDiv.style.zIndex = '9999';
                    errorDiv.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i> 
                        <strong>Error:</strong> ${message}
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-light me-2" onclick="location.reload()">
                                <i class="fas fa-refresh"></i> Refresh Page
                            </button>
                            <button class="btn btn-sm btn-outline-light" onclick="this.closest('.alert').remove()">
                                <i class="fas fa-times"></i> Dismiss
                            </button>
                        </div>
                    `;
                    document.body.appendChild(errorDiv);
                }
            }
            
            ErrorBoundary.initialize();
            
            class PerformanceMonitor {
                static trackOperation(name, operation) {
                    const start = performance.now();
                    
                    return Promise.resolve(operation()).finally(() => {
                        const duration = performance.now() - start;
                        console.log(`Operation ${name} took ${duration.toFixed(2)}ms`);
                        
                        if (duration > 5000) {
                            console.warn(`Slow operation detected: ${name} (${duration.toFixed(2)}ms)`);
                        }
                    });
                }
            }

            // Placeholder for RetryManager - to be properly implemented later
            class RetryManager {
                static async withRetry(operation, retries = 3, delay = 1000) {
                    for (let i = 0; i < retries; i++) {
                        try {
                            return await operation();
                        } catch (error) {
                            if (i < retries - 1) {
                                console.warn(`RetryManager: Attempt ${i + 1} failed, retrying in ${delay}ms...`, error);
                                await new Promise(resolve => setTimeout(resolve, delay));
                                delay *= 2; // Exponential backoff
                            } else {
                                throw error; // Last attempt, re-throw error
                            }
                        }
                    }
                }
            }

            // Placeholder for StateManager - to be properly implemented later
            class StateManager {
                static saveState(key, state) {
                    try {
                        localStorage.setItem(key, JSON.stringify(state));
                    } catch (e) {
                        console.error('Error saving state to localStorage', e);
                    }
                }

                static loadState(key) {
                    try {
                        const serializedState = localStorage.getItem(key);
                        return serializedState ? JSON.parse(serializedState) : undefined;
                    } catch (e) {
                        console.error('Error loading state from localStorage', e);
                        return undefined;
                    }
                }

                static clearState(key) {
                    try {
                        localStorage.removeItem(key);
                    } catch (e) {
                        console.error('Error clearing state from localStorage', e);
                    }
                }
            }
            
            const socket = io();
            const connectionManager = new ConnectionManager(socket);
            const chartManager = new ChartManager();
            const uploadManager = new UploadManager();

            // Declare DOM element variables
            const targetUsersFile = document.getElementById('targetUsersFile');
            const usageReports = document.getElementById('usageReports');
            const targetFileStatus = document.getElementById('target-file-status');
            const usageFilesStatus = document.getElementById('usage-files-status');
            const runAnalysisBtn = document.getElementById('run-analysis-btn');
            const statusLabel = document.getElementById('status-label');
            const reportsContainer = document.getElementById('reports-container');
            const downloadBtn = document.getElementById('download-btn');
            const searchBtn = document.getElementById('search-btn');
            const userEmailEntry = document.getElementById('user-email-entry');
            const deepDiveResults = document.getElementById('deep-dive-results');
            const deepDiveChartContainer = document.getElementById('deep-dive-chart-container');

            let uploadedUsageFiles = [];
            let reportDataForDownload = null;
            let deepDiveChart = null;
            
            // Debug: Check if elements exist
            console.log('Search button found:', searchBtn);
            console.log('Email entry found:', userEmailEntry);
            console.log('Deep dive results found:', deepDiveResults);
            console.log('Chart container found:', deepDiveChartContainer);
            
            // Manual tab handling as fallback
            const analysisTab = document.getElementById('analysis-tab');
            const deepdiveTab = document.getElementById('deepdive-tab');
            const analysisPane = document.getElementById('analysis-pane');
            const deepdivePane = document.getElementById('deepdive-pane');
            
            if (deepdiveTab && analysisTab && analysisPane && deepdivePane) {
                deepdiveTab.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Deep dive tab clicked');
                    
                    // Remove active classes
                    analysisTab.classList.remove('active');
                    analysisPane.classList.remove('show', 'active');
                    
                    // Add active classes
                    deepdiveTab.classList.add('active');
                    deepdivePane.classList.add('show', 'active');
                });
                
                analysisTab.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Analysis tab clicked');
                    
                    // Remove active classes
                    deepdiveTab.classList.remove('active');
                    deepdivePane.classList.remove('show', 'active');
                    
                    // Add active classes
                    analysisTab.classList.add('active');
                    analysisPane.classList.add('show', 'active');
                });
            }
            
            // Charting Setup with modern styling
            function createDistributionChart(elementId) {
                const options = {
                    chart: { 
                        type: 'donut', 
                        height: 280, 
                        background: 'transparent',
                        foreColor: '#888',
                        toolbar: { show: false },
                        animations: {
                            enabled: true,
                            easing: 'easeinout',
                            speed: 800,
                            animateGradually: {
                                enabled: true,
                                delay: 150
                            },
                            dynamicAnimation: {
                                enabled: true,
                                speed: 350
                            }
                        }
                    },
                    series: [],
                    labels: [],
                    // Meaningful colors that work well on dark backgrounds
                    // Power Users: Bright green (high performance)
                    // Consistent Users: Teal (steady, reliable)
                    // Coaching Needed: Amber (warning, needs attention)
                    // New Users: Blue (fresh, learning)
                    // License Recapture: Muted red (inactive, remove)
                    colors: ["#39FF14", "#14b8a6", "#f59e0b", "#60a5fa", "#dc2626"],
                    plotOptions: { 
                        pie: { 
                            donut: { 
                                size: '65%',
                                labels: { 
                                    show: true, 
                                    total: { 
                                        show: true, 
                                        label: 'Total',
                                        fontSize: '16px',
                                        fontWeight: 600,
                                        color: '#fff',
                                        formatter: function (w) {
                                            return w.globals.seriesTotals.reduce((a, b) => a + b, 0)
                                        }
                                    } 
                                } 
                            },
                            expandOnClick: true,
                            dataLabels: {
                                offset: 0,
                                minAngleToShowLabel: 10
                            }
                        } 
                    },
                    legend: { 
                        position: 'bottom', 
                        labels: { colors: ['#888'] },
                        fontSize: '12px'
                    },
                    stroke: {
                        show: true,
                        width: 2,
                        colors: ['#1a1a1a']  // Dark stroke to separate segments
                    },
                    dataLabels: {
                        enabled: true,
                        style: {
                            fontSize: '12px',
                            fontWeight: '600',
                            colors: ['#000', '#fff', '#000', '#000', '#fff']  // Black text on bright colors, white on dark
                        },
                        dropShadow: {
                            enabled: true,
                            top: 1,
                            left: 1,
                            blur: 1,
                            opacity: 0.5
                        }
                    },
                    theme: { mode: 'dark' }
                };
                const chart = new ApexCharts(document.querySelector(elementId), options);
                chart.render();
                return chart;
            }
            const distributionChart = createDistributionChart("#distribution-chart");
            
            // File Handling with modern UI feedback
            const handleFileUpload = (file, type, statusElement) => {
                return uploadManager.queueUpload(file, type, statusElement)
                .then(data => {
                     if (data.status === 'success') {
                         if (data.type === 'target') {
                             // For target file, show individual file status
                             const statusDiv = document.createElement('div');
                             statusDiv.className = 'status-message status-success';
                             statusDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${file.name} loaded successfully`;
                             statusElement.appendChild(statusDiv);
                             
                             populateSelect('company-filter', data.filters.companies);
                             populateSelect('department-filter', data.filters.departments);
                             populateSelect('location-filter', data.filters.locations);
                             populateSelect('manager-filter', data.filters.managers, window.preSelectedManagers);
            
                             if (window.preSelectedManagers && window.preSelectedManagers.length > 0) {
                                 const statusDiv = document.createElement('div');
                                 statusDiv.className = 'status-message status-success mt-2';
                                 statusDiv.innerHTML = `<i class="fas fa-check-circle"></i> Preset managers selected`;
                                 statusElement.appendChild(statusDiv);
                                 setTimeout(() => statusDiv.remove(), 3000);
                             }
                         } else if (data.type === 'usage') {
                             uploadedUsageFiles.push(data.filename);
                         }                return data; // Resolve promise
                    } else { throw new Error(data.message || 'File upload failed.'); }
                })
                .catch(error => {
                    console.error('Upload Error:', error);
                    if (type === 'target') {
                        const statusDiv = document.createElement('div');
                        statusDiv.className = 'status-message status-error';
                        statusDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> Failed to upload ${file.name}`;
                        statusElement.appendChild(statusDiv);
                    }
                    throw error; // Reject promise
                });
            };
            
            targetUsersFile.addEventListener('change', (e) => {
                console.log('targetUsersFile change event triggered!', e.target.files);
                if (e.target.files.length > 0) {
                    targetFileStatus.innerHTML = '';
                    const filterSelects = ['company-filter', 'department-filter', 'location-filter', 'manager-filter'];
                    filterSelects.forEach(id => {
                        const select = document.getElementById(id);
                        select.innerHTML = '<option>Loading...</option>';
                        select.disabled = true;
                    });
                    handleFileUpload(e.target.files[0], 'target', targetFileStatus).finally(() => {
                        filterSelects.forEach(id => {
                            document.getElementById(id).disabled = false;
                        });
                    });
                }
            });
            usageReports.addEventListener('change', (e) => {
                console.log('usageReports change event triggered!', e.target.files);

                if (e.target.files.length === 0) return;
                usageFilesStatus.innerHTML = '';
                uploadedUsageFiles = []; 
                runAnalysisBtn.disabled = true;
                runAnalysisBtn.innerHTML = `<span class="loading-spinner"></span> Uploading Files...`;
            
                const totalFiles = e.target.files.length;
                let successCount = 0;
                let failCount = 0;
            
                const uploadPromises = [...e.target.files].map(file => 
                    handleFileUpload(file, 'usage', usageFilesStatus)
                        .then(() => { successCount++; })
                        .catch(() => { failCount++; })
                );
                
                Promise.allSettled(uploadPromises)
                    .then(() => {
                        runAnalysisBtn.disabled = false;
                        runAnalysisBtn.innerHTML = '<i class="fas fa-play"></i> Run Analysis';
                        
                        // Show single summary bubble
                        usageFilesStatus.innerHTML = '';
                        if (successCount > 0) {
                            const statusDiv = document.createElement('div');
                            statusDiv.className = 'status-message status-success';
                            statusDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${successCount} usage report${successCount > 1 ? 's' : ''} loaded successfully`;
                            usageFilesStatus.appendChild(statusDiv);
                        }
                        
                        if (failCount > 0) {
                            const errorDiv = document.createElement('div');
                            errorDiv.className = 'status-message status-error';
                            errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${failCount} file${failCount > 1 ? 's' : ''} failed to upload`;
                            usageFilesStatus.appendChild(errorDiv);
                        }
                        
                        console.log(`Upload complete: ${successCount} succeeded, ${failCount} failed out of ${totalFiles} total.`);
                    });
            });
            
            // Socket.IO Handlers
            socket.on('connect', () => console.log('Socket.IO connection established!'));
            socket.on('status_update', (data) => {
                statusLabel.innerHTML = `<i class="fas fa-cog fa-spin"></i> ${data.message}`;
                statusLabel.style.color = '#888';
            });
            
            socket.on('analysis_complete', (data) => {
                runAnalysisBtn.disabled = false;
                runAnalysisBtn.innerHTML = '<i class="fas fa-play"></i> Run Analysis';
                statusLabel.innerHTML = '<i class="fas fa-check-circle"></i> Analysis complete!';
                statusLabel.style.color = '#39FF14';
                
                const { total, categories } = data.dashboard;
                
                // Animate the total users counter
                const totalElement = document.getElementById('total-users');
                let currentValue = 0;
                const targetValue = total;
                const increment = Math.ceil(targetValue / 30);
                const timer = setInterval(() => {
                    currentValue += increment;
                    if (currentValue >= targetValue) {
                        currentValue = targetValue;
                        clearInterval(timer);
                    }
                    totalElement.textContent = currentValue;
                }, 30);
                
                distributionChart.updateSeries([
                    categories.power_user || 0,
                    categories.consistent_user || 0,
                    categories.coaching || 0,
                    categories.new_user || 0,
                    categories.recapture || 0
                ]);
                distributionChart.updateOptions({
                    labels: ['Power Users', 'Consistent Users', 'Coaching Needed', 'New Users', 'License Recapture']
                });
                
                reportDataForDownload = data.reports;
                reportDataForDownload.excel_bytes = undefined;
                reportsContainer.style.display = 'block';
                
                // Add a subtle animation to the reports container
                reportsContainer.style.opacity = '0';
                setTimeout(() => {
                    reportsContainer.style.transition = 'opacity 0.5s ease';
                    reportsContainer.style.opacity = '1';
                }, 100);
            });
            
            socket.on('analysis_error', (data) => {
                runAnalysisBtn.disabled = false;
                runAnalysisBtn.innerHTML = '<i class="fas fa-play"></i> Run Analysis';
                statusLabel.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Error: ${data.message}`;
                statusLabel.style.color = '#ef4444';
                
                // Show a more modern error notification instead of alert
                showErrorNotification(`Analysis Error: ${data.message}`);
            });
            
            socket.on('deep_dive_result', (data) => {
                deepDiveResults.textContent = data.text;
                if (deepDiveChart) {
                    chartManager.destroyChart("deep-dive-chart-container");
                }
                const chartOptions = {
                    chart: { 
                        type: 'line', 
                        height: 380, 
                        background: 'transparent', 
                        foreColor: '#888',
                        toolbar: { show: false },
                        animations: {
                            enabled: true,
                            easing: 'easeinout',
                            speed: 800
                        }
                    },
                    series: data.chart_data.series,
                    xaxis: { 
                        categories: data.chart_data.categories, 
                        labels: { 
                            style: { colors: '#888' },
                            rotate: -45
                        },
                        axisBorder: { color: '#333' },
                        axisTicks: { color: '#333' }
                    },
                    yaxis: { 
                        title: { 
                            text: 'Average Tools Used', 
                            style: { color: '#888', fontSize: '14px' } 
                        }, 
                        labels: { style: { colors: '#888' } },
                        axisBorder: { color: '#333' },
                        axisTicks: { color: '#333' }
                    },
                    colors: ['#39FF14', '#60a5fa', '#ef4444'],
                    stroke: {
                        curve: 'smooth',
                        width: 3
                    },
                    markers: {
                        size: 0,  // Hide markers by default
                        hover: { size: 5 } // Show markers on hover
                    },
                    legend: { 
                        labels: { colors: '#888' },
                        position: 'top',
                        horizontalAlign: 'right'
                    },
                    grid: { 
                        borderColor: '#333',
                        strokeDashArray: 4
                    },
                    tooltip: { 
                        theme: 'dark',
                        x: { format: 'dd MMM yyyy' }
                    }
                };
                deepDiveChart = chartManager.createChart("deep-dive-chart-container", chartOptions);
            });
            socket.on('deep_dive_error', (data) => {
                deepDiveResults.textContent = `Error: ${data.message}`;
                deepDiveResults.style.color = '#ef4444';
                
                // Clear the chart container
                if (deepDiveChartContainer) {
                    deepDiveChartContainer.innerHTML = '';
                }
                
                // Show error notification
                showErrorNotification(`Deep Dive Error: ${data.message}`);
            });
            
            // Action Button Listeners
            runAnalysisBtn.addEventListener('click', async () => {
                runAnalysisBtn.disabled = true;
                runAnalysisBtn.innerHTML = `<span class="loading-spinner"></span> Analyzing...`;
                reportsContainer.style.display = 'none';
                statusLabel.innerHTML = '<i class="fas fa-cog fa-spin"></i> Starting analysis...';
                statusLabel.style.color = 'var(--neon-green)';
                const filters = {
                    companies: getSelectedOptions('company-filter'),
                    departments: getSelectedOptions('department-filter'),
                    locations: getSelectedOptions('location-filter'),
                    managers: getSelectedOptions('manager-filter'),
                };
                try {
                    await PerformanceMonitor.trackOperation('start_analysis', async () => {
                        await RetryManager.withRetry(async () => {
                            socket.emit('start_analysis', { 
                                filters: filters,
                                usage_filenames: uploadedUsageFiles 
                            });
                        });
                    });
                } catch (error) {
                    // This error will be caught by the socket.on('analysis_error') handler
                    // or the global error boundary if it's a critical failure before emit
                    console.error('Analysis initiation failed:', error);
                    showErrorNotification('Analysis failed after multiple attempts. Please refresh and try again.');
                }
            });
            
            downloadBtn.addEventListener('click', () => {
                // --- THIS IS THE FIX ---
                // Use the report data that was saved in the browser
                if (reportDataForDownload) {
                    triggerDownload(reportDataForDownload.excel_b64, `Copilot Analysis Report.xlsx`, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
                    setTimeout(() => triggerDownload(reportDataForDownload.html_b64, 'leaderboard.html', 'text/html'), 500);
                } else {
                    alert('No report data available to download.');
                }
            });
            
            // Add click handler with error catching
            if (searchBtn) {
                console.log('Adding click handler to search button');
                searchBtn.onclick = function(e) {
                    e.preventDefault();
                    console.log('Search button clicked!');
                    
                    try {
                        const email = userEmailEntry.value.trim();
                        console.log('Email value:', email);
                        
                        if (email) {
                            deepDiveResults.textContent = "Searching...";
                            deepDiveResults.style.color = '#888';
                            
                            if (deepDiveChart) {
                                chartManager.destroyChart("deep-dive-chart-container");
                                deepDiveChartContainer.innerHTML = '<div class="d-flex justify-content-center align-items-center h-100"><span class="loading-spinner"></span></div>';
                            }
                            
                            console.log('Emitting deep dive request for:', email);
                            PerformanceMonitor.trackOperation('perform_deep_dive', async () => {
                                socket.emit('perform_deep_dive', { email: email });
                            });
                        } else {
                            console.log('No email entered');
                            showWarningNotification('Please enter an email address to search.');
                        }
                    } catch (error) {
                        console.error('Error in search button handler:', error);
                    }
                };
            } else {
                console.error('Search button not found!');
            }
            
            function showErrorNotification(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'position-fixed top-0 start-50 translate-middle-x mt-3 alert alert-danger alert-dismissible fade show';
                errorDiv.style.zIndex = '9999';
                errorDiv.innerHTML = `
                    <i class="fas fa-exclamation-circle"></i> <strong>Error:</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(errorDiv);
                setTimeout(() => errorDiv.remove(), 5000);
            }
            
            function showWarningNotification(message) {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'position-fixed top-0 start-50 translate-middle-x mt-3 alert alert-warning alert-dismissible fade show';
                warningDiv.style.zIndex = '9999';
                warningDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(warningDiv);
                setTimeout(() => warningDiv.remove(), 3000);
            }
            
            // Also add Enter key support for the email input
            if (userEmailEntry) {
                userEmailEntry.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        searchBtn.click();
                    }
                });
            }
            
            // Helper Functions
            function populateSelect(selectId, options, preSelected = []) {
                const select = document.getElementById(selectId);
                select.innerHTML = '';
                if (options) {
                    options.forEach(optionText => {
                        const option = document.createElement('option');
                        option.value = optionText;
                        option.textContent = optionText;
                        if (preSelected.includes(optionText)) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                }
            }
            function getSelectedOptions(selectId) {
                const select = document.getElementById(selectId);
                return [...select.selectedOptions].map(option => option.value);
            }
            function triggerDownload(base64Data, fileName, mimeType) {
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: mimeType });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
    }


class ConnectionManager {
    constructor(socket) {
        this.socket = socket;
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 5;
        this.setupConnectionHandlers();
    }
    
    setupConnectionHandlers() {
        this.socket.on('connect', () => {
            console.log('Connected to server');
            this.reconnectAttempts = 0;
            this.showConnectionStatus('connected');
        });
        
        this.socket.on('disconnect', () => {
            console.log('Disconnected from server');
            this.showConnectionStatus('disconnected');
            this.attemptReconnect();
        });
        
        this.socket.on('connect_error', (error) => {
            console.error('Connection error:', error);
            this.showConnectionStatus('error');
        });
    }
    
    attemptReconnect() {
        if (this.reconnectAttempts < this.maxReconnectAttempts) {
            this.reconnectAttempts++;
            setTimeout(() => {
                console.log(`Reconnection attempt ${this.reconnectAttempts}`);
                this.socket.connect();
            }, Math.pow(2, this.reconnectAttempts) * 1000);
        }
    }
    
    showConnectionStatus(status) {
        // Update UI to show connection status
        const statusElement = document.getElementById('connection-status');
        if (statusElement) {
            statusElement.className = `connection-status ${status}`;
            statusElement.textContent = status === 'connected' ? 'Connected' : 
                                      status === 'disconnected' ? 'Reconnecting...' : 'Connection Error';
        }
    }
}

class UploadManager {
    constructor() {
        this.uploadQueue = [];
        this.isUploading = false;
        this.uploadedFiles = new Map();
    }
    
    async queueUpload(file, type, statusElement) {
        return new Promise((resolve, reject) => {
            this.uploadQueue.push({ file, type, statusElement, resolve, reject });
            this.processQueue();
        });
    }
    
    async processQueue() {
        if (this.isUploading || this.uploadQueue.length === 0) return;
        
        this.isUploading = true;
        const upload = this.uploadQueue.shift();
        
        try {
            const result = await this.performUpload(upload);
            upload.resolve(result);
        } catch (error) {
            upload.reject(error);
        } finally {
            this.isUploading = false;
            this.processQueue();
        }
    }
    
    async performUpload(upload) {
        const { file, type, statusElement } = upload;
        const formData = new FormData();
        formData.append('file', file);
        formData.append('file_type', type);
        
        const response = await fetch('/upload', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Upload failed');
        }
        
        return await response.json();
    }
}

        }

        function showCriticalError(message) {
            document.body.innerHTML = `
                <div class="alert alert-danger m-4">
                    <h4>Loading Error</h4>
                    <p>${message}</p>
                    <button onclick="location.reload()" class="btn btn-primary">Refresh Page</button>
                </div>
            `;
        }

        window.preSelectedManagers = {{ pre_selected_managers | tojson }};
    </script>
    <footer class="mt-5 text-center text-muted small">
        <p>&copy; 2024 Copilot Analytics. All rights reserved.</p>
        <p><a href="/static/licenseclasses.html" class="text-decoration-none text-muted hover-neon-green">License Classes</a></p>
    </footer>
</body>
</html>
